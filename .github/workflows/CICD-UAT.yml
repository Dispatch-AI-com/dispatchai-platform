name: Automatic pipeline for UAT deployment

run-name: >
  ${{ github.event_name == 'repository_dispatch' && format('UAT pipeline is triggered by {0} (by {1})', github.event.client_payload.submodule, github.event.client_payload.actor) ||
      github.event_name == 'workflow_dispatch' && format('Manual UAT pipeline (by {0})', github.actor) }}

on:
  repository_dispatch:
    types: [submodule-updated]

  workflow_dispatch:
    inputs:
      submodule:
        description: "Choose app to build and deploy"
        required: true
        type: choice
        options:
          - frontend
          - api
          - ai
        
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'workflow_dispatch' && format('manual-{0}', inputs.submodule) || github.event.client_payload.submodule || inputs.submodule }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  IMAGE_TAG: uat-${{ github.run_number }}
  SUBMODULE: ${{ github.event.client_payload.submodule || inputs.submodule }}

jobs:
  frontend_deployment:
    if: ${{ github.event.client_payload.submodule == 'Dispatch-AI-com/frontend' || inputs.submodule == 'frontend' }}
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/frontend

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Hello from frontend
        run: |
          echo "Submodule: ${{ github.event.client_payload.submodule }}"
          echo "Branch: ${{ github.event.client_payload.ref }}"

      - name: Update submodules to latest main
        working-directory: .
        run: |
          git submodule update --init --recursive --remote
          git submodule status

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        run: npm install -g pnpm

      - name: pnpm install
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm run type-check

      - name: Lint
        run: pnpm run lint

      - name: Test
        run: pnpm test

      - name: Build (inject NEXT_PUBLIC_API_BASE_URL)
        run: |
          NEXT_PUBLIC_API_BASE_URL="${{ secrets.BACKEND_URL_UAT }}" pnpm build

      - name: Verify build output
        run: |
          echo "PWD:"
          pwd
          echo "List:"
          ls -la

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_CICD_ROLE_ARN_UAT }}
          aws-region: ${{ secrets.AWS_REGION_UAT }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v6
        with:
          push: true
          context: ./apps/frontend
          file: ./apps/frontend/Dockerfile.uat
          tags: |
            ${{ secrets.FRONTEND_ECR_UAT }}:${{ env.IMAGE_TAG }}
          platforms: linux/amd64
          provenance: false

      - name: Deploy via SSM SendCommand
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions deploy frontend. Image:${{ env.IMAGE_TAG }}." \
            --parameters "commands=['sudo bash /home/ubuntu/devops/deployment/uat/deploy-frontend-uat.sh ${{ env.IMAGE_TAG }}']" \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID_UAT }}" \
            --region "${{ secrets.AWS_REGION_UAT }}"




  api_ci:
    runs-on: ubuntu-latest
    if: ${{ github.event.client_payload.submodule == 'Dispatch-AI-com/backend' || inputs.submodule == 'backend' }}
    steps:
      - name: Hello from api
        run: |
          echo "Submodule: ${{ github.event.client_payload.submodule }}"
          echo "Branch: ${{ github.event.client_payload.ref }}"
  ai_ci:
    runs-on: ubuntu-latest
    if: ${{ github.event.client_payload.submodule == 'Dispatch-AI-com/ai' || inputs.submodule == 'ai' }}
    steps:
      - name: Hello from ai
        run: |
          echo "Submodule: ${{ github.event.client_payload.submodule }}"
          echo "Branch: ${{ github.event.client_payload.ref }}"
