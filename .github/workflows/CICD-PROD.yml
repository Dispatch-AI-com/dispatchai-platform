name: Production deployment pipeline

run-name: >
  Production deployment for tag ${{ inputs.git_tag }} (services: ${{ inputs.deploy_frontend && 'frontend' || '' }}${{ inputs.deploy_frontend && inputs.deploy_api && ',' || '' }}${{ inputs.deploy_api && 'api' || '' }}${{ (inputs.deploy_frontend || inputs.deploy_api) && inputs.deploy_ai && ',' || '' }}${{ inputs.deploy_ai && 'ai' || '' }}) by ${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      git_tag:
        description: "Git tag to deploy (e.g., v1.0.0)"
        required: true
        type: string
      deploy_frontend:
        description: "Deploy frontend service"
        required: false
        type: boolean
        default: false
      deploy_api:
        description: "Deploy API service"
        required: false
        type: boolean
        default: false
      deploy_ai:
        description: "Deploy AI service"
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ inputs.git_tag }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  IMAGE_TAG: ${{ inputs.git_tag }}
  GIT_TAG: ${{ inputs.git_tag }}

jobs:
  validate_inputs:
    runs-on: ubuntu-latest
    outputs:
      should_deploy_frontend: ${{ steps.check.outputs.deploy_frontend }}
      should_deploy_api: ${{ steps.check.outputs.deploy_api }}
      should_deploy_ai: ${{ steps.check.outputs.deploy_ai }}
      tag_exists: ${{ steps.validate_tag.outputs.exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate at least one service selected
        run: |
          if [ "${{ inputs.deploy_frontend }}" != "true" ] && \
             [ "${{ inputs.deploy_api }}" != "true" ] && \
             [ "${{ inputs.deploy_ai }}" != "true" ]; then
            echo "❌ Error: At least one service must be selected for deployment"
            exit 1
          fi
          echo "✅ At least one service selected"

      - name: Validate Git tag exists
        id: validate_tag
        run: |
          TAG="${{ inputs.git_tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "✅ Git tag $TAG exists"
            echo "exists=true" >> $GITHUB_OUTPUT
            git show-ref --tags | grep "$TAG" || true
          else
            echo "❌ Error: Git tag $TAG does not exist"
            echo "Available tags:"
            git tag -l | tail -20 || true
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Set service deployment flags
        id: check
        run: |
          echo "deploy_frontend=${{ inputs.deploy_frontend }}" >> $GITHUB_OUTPUT
          echo "deploy_api=${{ inputs.deploy_api }}" >> $GITHUB_OUTPUT
          echo "deploy_ai=${{ inputs.deploy_ai }}" >> $GITHUB_OUTPUT

  frontend_deployment:
    needs: validate_inputs
    if: needs.validate_inputs.outputs.should_deploy_frontend == 'true' && needs.validate_inputs.outputs.tag_exists == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/frontend

    steps:
      - name: Checkout repository at specific tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_tag }}
          submodules: recursive
          fetch-depth: 0

      - name: Update submodules to tag versions
        working-directory: .
        run: |
          git submodule update --init --recursive
          git submodule status

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        run: npm install -g pnpm

      - name: pnpm install
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm run type-check

      - name: Lint
        run: pnpm run lint

      - name: Test
        run: pnpm test

      - name: Build (inject NEXT_PUBLIC_API_BASE_URL)
        run: |
          NEXT_PUBLIC_API_BASE_URL="${{ secrets.PROD_BACKEND_URL }}" pnpm build

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PROD_AWS_CICD_ROLE_ARN }}
          aws-region: ${{ secrets.PROD_AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v6
        with:
          push: true
          context: ./apps/frontend
          file: ./apps/frontend/Dockerfile.uat
          tags: |
            ${{ secrets.PROD_ECR_FRONTEND }}:${{ env.IMAGE_TAG }}
          platforms: linux/amd64
          provenance: false

      - name: Deploy via SSM SendCommand
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions deploy frontend to PROD. Tag:${{ env.IMAGE_TAG }}." \
            --parameters '{"workingDirectory":["/home/ubuntu/devops/deployment/prod"],"commands":["sudo bash ./deploy-frontend-prod.sh '"${IMAGE_TAG}"'"]}' \
            --cloud-watch-output-config "CloudWatchLogGroupName=/ssm/prod/deployment/frontend/,CloudWatchOutputEnabled=true" \
            --instance-ids "${{ secrets.PROD_EC2_INSTANCE_ID }}" \
            --region "${{ secrets.PROD_AWS_REGION }}"

  api_deployment:
    needs: validate_inputs
    if: needs.validate_inputs.outputs.should_deploy_api == 'true' && needs.validate_inputs.outputs.tag_exists == 'true'
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: ./apps/backend

    steps:
      - name: Checkout repository at specific tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_tag }}
          submodules: recursive
          fetch-depth: 0

      - name: Update submodules to tag versions
        working-directory: .
        run: |
          git submodule update --init --recursive
          git submodule status

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        run: npm install -g pnpm

      - name: pnpm install
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm run type-check

      - name: Lint
        run: pnpm run lint

      - name: Run Unit & Integration Tests
        run: pnpm test:ci
        env:
          CI: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PROD_AWS_CICD_ROLE_ARN }}
          aws-region: ${{ secrets.PROD_AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v6
        with:
          push: true
          context: ./apps/backend
          file: ./apps/backend/Dockerfile.uat
          tags: |
            ${{ secrets.PROD_ECR_BACKEND_API }}:${{ env.IMAGE_TAG }}
          platforms: linux/amd64
          provenance: false

      - name: Deploy via SSM SendCommand
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions deploy backend-api to PROD. Tag:${{ env.IMAGE_TAG }}." \
            --parameters '{"workingDirectory":["/home/ubuntu/devops/deployment/prod"],"commands":["sudo bash ./deploy-api-prod.sh '"${IMAGE_TAG}"'"]}' \
            --cloud-watch-output-config "CloudWatchLogGroupName=/ssm/prod/deployment/api/,CloudWatchOutputEnabled=true" \
            --instance-ids "${{ secrets.PROD_EC2_INSTANCE_ID }}" \
            --region "${{ secrets.PROD_AWS_REGION }}"

  ai_deployment:
    needs: validate_inputs
    if: needs.validate_inputs.outputs.should_deploy_ai == 'true' && needs.validate_inputs.outputs.tag_exists == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/ai

    steps:
      - name: Checkout repository at specific tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_tag }}
          submodules: recursive
          fetch-depth: 0

      - name: Update submodules to tag versions
        working-directory: .
        run: |
          git submodule update --init --recursive
          git submodule status

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install uv
        run: pip install --upgrade uv

      - name: uv sync
        run: uv sync --all-extras --dev

      - name: Lint
        run: make lint

      - name: Format Check
        run: make format

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PROD_AWS_CICD_ROLE_ARN }}
          aws-region: ${{ secrets.PROD_AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v6
        with:
          push: true
          context: ./apps/ai
          file: ./apps/ai/Dockerfile.uat
          tags: |
            ${{ secrets.PROD_ECR_BACKEND_AI }}:${{ env.IMAGE_TAG }}
          platforms: linux/amd64
          provenance: false

      - name: Deploy via SSM SendCommand
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions deploy AI service to PROD. Tag:${{ env.IMAGE_TAG }}." \
            --parameters '{"workingDirectory":["/home/ubuntu/devops/deployment/prod"],"commands":["sudo bash ./deploy-ai-prod.sh '"${IMAGE_TAG}"'"]}' \
            --cloud-watch-output-config "CloudWatchLogGroupName=/ssm/prod/deployment/ai/,CloudWatchOutputEnabled=true" \
            --instance-ids "${{ secrets.PROD_EC2_INSTANCE_ID }}" \
            --region "${{ secrets.PROD_AWS_REGION }}"

